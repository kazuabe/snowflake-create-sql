# Streamlit Snowflake SQL Generator

初心者向けのSQLジェネレーターアプリケーションです。StreamlitとSnowflakeを使用して、GUIベースでSQLクエリを作成・実行できます。

## 概要

このアプリケーションは、SQLの知識が少ないユーザーでも直感的にSQLクエリを作成できるように設計されています。以下の機能を提供します：

- **視覚的なSQL構築**: ドラッグ&ドロップのような感覚でSQLクエリを作成
- **リアルタイムプレビュー**: 作成中のSQLをリアルタイムで確認
- **サンプル実行**: 生成されたSQLを実際に実行して結果を確認
- **テーブル結合**: 複数テーブルの結合を簡単に設定
- **セキュリティ機能**: SQLインジェクション対策と入力値検証
- **エラーハンドリング**: 詳細なエラー情報とユーザーフレンドリーなメッセージ

## 主な機能

### 1. データベース・スキーマ・テーブル選択
- Snowflakeのデータベース、スキーマ、テーブルを階層的に選択
- 主テーブル（クエリの起点）を指定
- テーブル結合（JOIN）の設定

### 2. SQL項目と条件の指定
- **SELECT句**: 表示・集計する項目を選択
  - 集計関数: COUNT, SUM, AVG, MIN, MAX, COUNT(DISTINCT)
  - グループ化キーとして使用する項目も設定可能
- **WHERE句**: データの絞り込み条件を設定
  - 比較演算子: =, !=, >, >=, <, <=
  - 文字列検索: 部分一致、前方一致、後方一致
  - 複数選択: IN句
  - NULL値チェック: IS NULL, IS NOT NULL
- **JOIN句**: テーブル結合の設定
  - 結合タイプ: INNER JOIN, LEFT JOIN
  - 結合条件（ON句）の設定

### 3. SQL生成と実行
- 設定内容に基づいてSQLを自動生成
- 生成されたSQLの確認
- サンプルデータ（最大10行）での実行テスト

## 技術仕様

### 使用技術
- **フロントエンド**: Streamlit
- **データベース**: Snowflake
- **Pythonライブラリ**:
  - `streamlit`: Webアプリケーションフレームワーク
  - `snowflake.snowpark`: Snowflake接続・操作
  - `pandas`: データ処理
  - `uuid`: ユニークID生成
  - `typing`: 型ヒント
  - `logging`: ログ機能
  - `re`: 正規表現（セキュリティ検証）

### 実行環境
- **Streamlit in Snowflake**: Snowflake環境内での実行を想定
- **Python**: 3.8以上
- Snowflakeセッションが必要

## セットアップ

### 1. 環境構築

#### Conda環境でのセットアップ（推奨）
```bash
# 環境の作成
conda env create -f requirements.yaml

# 環境のアクティベート
conda activate streamlit-snowflake-sql-generator
```

#### 既存環境への追加
```bash
conda env update -f requirements.yaml
```

### 2. アプリケーションの起動
```bash
streamlit run app.py
```

## 使用方法

### 1. クエリ作成の手順

#### STEP 1: データベース/スキーマ/テーブルを選択
1. データベースを選択
2. スキーマを選択
3. 主テーブルを選択
4. 必要に応じてテーブル結合を追加

#### STEP 2: SQLの項目と条件を指定
1. 表示・集計する項目を選択
2. 集計方法を指定（必要に応じて）
3. WHERE句の条件を設定

#### STEP 3: SQLを確認して実行
1. 生成されたSQLを確認
2. サンプルクエリを実行して結果を確認

## セキュリティ機能

### 入力値検証
- **識別子サニタイズ**: データベース名、スキーマ名、テーブル名の検証
- **SQL値検証**: WHERE句の値に対するセキュリティチェック
- **危険なパターン検出**: SQLインジェクション攻撃の検出

### エラーハンドリング
- **統一されたエラー処理**: データベースエラーの統一処理
- **ユーザーフレンドリーなメッセージ**: 分かりやすいエラー説明
- **詳細なログ出力**: デバッグ情報の提供

## 特徴

### 初心者フレンドリー
- 日本語UIで直感的な操作
- ヘルプテキストとツールチップで操作をサポート
- リアルタイムでのSQLプレビュー

### 柔軟な条件設定
- 複数のWHERE条件をAND/ORで組み合わせ
- 様々な演算子とデータ型に対応
- 動的な条件の追加・削除

### パフォーマンス最適化
- データベース情報のキャッシュ機能
- 効率的なクエリ実行
- エラーハンドリング

### 型安全性
- 型ヒントによるコードの安全性向上
- 関数の戻り値の明確化
- コンパイル時エラーの検出

## 制限事項

- Snowflake環境での実行が必要
- 複雑なサブクエリには対応していない
- 特定の高度なSQL機能（ウィンドウ関数など）は未対応

## トラブルシューティング

### よくある問題

#### 1. Snowflakeセッションエラー
```
Snowflakeセッションの取得に失敗しました
```
**解決策**: Streamlit in Snowflake環境で実行していることを確認してください。

#### 2. 権限エラー
```
テーブル定義の取得に失敗しました
```
**解決策**: 必要なデータベース権限があるか確認してください。

#### 3. 構文エラー
```
SQLクエリの生成中にエラーが発生しました
```
**解決策**: 入力値に特殊文字が含まれていないか確認してください。

## ライセンス

このプロジェクトのライセンス情報については、プロジェクト管理者にお問い合わせください。

## サポート

問題や質問がある場合は、プロジェクトのIssuesページで報告してください。